<!-- âœ… å®Œæ•´çš„å–®ä¸€é é¢ï¼šdashboard.html -->
<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <title>æµ·å»¢è¾¨è­˜åœ–é‘‘ç³»çµ±</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: auto;
            padding: 20px;
            background: #f0f8ff;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        button {
            margin: 10px 5px;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
        }

        form {
            margin-bottom: 20px;
        }

        img {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 10px;
        }

        .grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .card {
            width: 160px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 10px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
    </style>
</head>

<body>
    <header>
        <h2>ğŸŒŠ æµ·å»¢è¾¨è­˜ç³»çµ±</h2>
        <div>
            <span id="welcomeMsg">æ­¡è¿ï¼</span>
            <a href="/logout"><button>ç™»å‡º</button></a>
        </div>
    </header>

    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" id="imageInput" accept="image/*" required>
        <button type="submit">ä¸Šå‚³ä¸¦è¾¨è­˜</button>
    </form>

    <h3>ğŸ“… å¯åƒåŠ çš„æ´»å‹•</h3>
    <div id="eventList" class="grid"></div>
    

    <h3>âœ… æˆ‘å·²åƒåŠ çš„æ´»å‹•</h3>
    <div id="joinedList" class="grid"></div>


    <div id="preview"></div>
    <div id="result"></div>
    <h3>ğŸ“– æˆ‘çš„åœ–é‘‘</h3>
    <div id="dexList" class="grid"></div>

    <script>
        const USERNAME = "{{ username }}";
        const USER_ID = "{{ user_id }}";
        document.getElementById("welcomeMsg").innerText = `æ­¡è¿ï¼Œ${USERNAME}ï¼`;

        const unlocked = new Set();
        const DEX = {
            "001": { name: "å¯¶ç‰¹ç“¶", image: "/static/dex/001.png" },
            "002": { name: "å¯¶ç‰¹ç“¶ç“¶è“‹", image: "/static/dex/002.png" },
            "003": { name: "éµé‹ç½", image: "/static/dex/003.png" },
            "004": { name: "é‹ç®”å®¹å™¨", image: "/static/dex/004.png" },
            "005": { name: "ç´™å¼µ", image: "/static/dex/005.png" },
            "006": { name: "ç´™ç®±", image: "/static/dex/006.png" },
            "007": { name: "ç´™é¤ç›’", image: "/static/dex/007.png" },
            "008": { name: "é¦™è¸ç›’", image: "/static/dex/008.png" },
            "009": { name: "å¡‘è† æ¹¯åŒ™", image: "/static/dex/009.png" },
            "010": { name: "å¡‘è† å‰å­", image: "/static/dex/010.png" },
            "011": { name: "å…æ´—æ¯", image: "/static/dex/011.png" },
            "012": { name: "å¡‘è† æ‰‹æ–é£²æ–™æ¯", image: "/static/dex/012.png" },
            "013": { name: "ä¿éº—é¾é£²æ–™æ¯", image: "/static/dex/013.png" },
            "014": { name: "å¡‘è† è¢‹", image: "/static/dex/014.png" },
            "015": { name: "å¡‘è† å¸ç®¡", image: "/static/dex/015.png" },
            "016": { name: "ä¿éº—é¾å¡Š", image: "/static/dex/016.png" },
            "017": { name: "æ¼ç¶²", image: "/static/dex/017.png" },
            "018": { name: "æµ®æ¨™", image: "/static/dex/018.png" },
            "019": { name: "æµ®çƒ", image: "/static/dex/019.png" },
            "020": { name: "æ‰“ç«æ©Ÿ", image: "/static/dex/020.png" },
            "021": { name: "æ£‰èŠ±æ£’", image: "/static/dex/021.png" },
            "022": { name: "è¸è’‚", image: "/static/dex/022.png" },
            "023": { name: "å¤¾è…³æ‹–", image: "/static/dex/023.png" },
            "024": { name: "ç»ç’ƒç½", image: "/static/dex/024.png" },
            "025": { name: "ç»ç’ƒç¢ç‰‡", image: "/static/dex/025.png" }
        };

        async function fetchUnlocked() {
            const res = await fetch("/get_unlocked");
            const data = await res.json();
            for (const id of data.unlocked_ids) {
                unlocked.add(id);
            }
            renderDex();
        }
        

        async function fetchEvents() {
            const res = await fetch("/get_events");
            const data = await res.json();
            const eventList = document.getElementById("eventList");
            eventList.innerHTML = '';

            for (const event of data.events) {
                eventList.innerHTML += `
                <div class="card">
                    <h4>${event.title}</h4>
                    <p>${event.location}</p>
                    <p>${new Date(event.datetime).toLocaleString()}</p>
                    <button onclick="joinEvent('${event.id}')">åƒåŠ </button>
                </div>`;
            }
        }

        async function joinEvent(eventId) {
            const res = await fetch(`/join_event/${eventId}`, {
                method: "POST"
            });
            const text = await res.text();
            alert("å·²é€å‡ºåƒåŠ è«‹æ±‚");
        }

        fetchEvents();

        async function fetchJoinedEvents() {
            const res = await fetch("/get_joined_events");
            const data = await res.json();
            const joinedList = document.getElementById("joinedList");
            joinedList.innerHTML = '';

            for (const event of data.events) {
                joinedList.innerHTML += `
                <div class="card">
                    <h4>${event.title}</h4>
                    <p>${event.location}</p>
                    <p>${new Date(event.datetime).toLocaleString()}</p>
                </div>`;
            }
        }

        fetchJoinedEvents();
        

        function renderDex() {
            const dexList = document.getElementById("dexList");
            dexList.innerHTML = '';
            for (let id in DEX) {
                const item = DEX[id];
                const imgSrc = unlocked.has(id) ? item.image : "/static/dex/unknow.png";
                dexList.innerHTML += `
          <div class="card">
            <img src="${imgSrc}" alt="åœ–é‘‘">
            <p>${item.name}</p>
            <p>#${id}</p>
          </div>`;
            }
        }

        document.getElementById("uploadForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const file = document.getElementById("imageInput").files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => {
                document.getElementById("preview").innerHTML = `<img src="${reader.result}" alt="preview">`;
            };
            reader.readAsDataURL(file);

            const formData = new FormData();
            formData.append("image", file);

            const res = await fetch("/analyze_trash", {
                method: "POST",
                body: formData
            });

            const data = await res.json();
            const result = document.getElementById("result");

            if (data.unlocked_id) {
                unlocked.add(data.unlocked_id);
                result.innerHTML = `
          <h3>ğŸ” è¾¨è­˜çµæœï¼š${data.unlocked_name}</h3>
          <img src="${data.unlocked_image}" alt="åœ–é‘‘åœ–ç‰‡">
          <p>åœ–é‘‘ç·¨è™Ÿï¼š${data.unlocked_id}</p>
        `;
            } else {
                result.innerHTML = `<h3>âŒ ç„¡æ³•è¾¨è­˜</h3>`;
            }

            renderDex();
        });

        fetchUnlocked();
    </script>
</body>

</html>